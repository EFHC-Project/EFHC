# -*- coding: utf-8 -*-
# backend/app/schemas/referrals_schemas.py
# =============================================================================
# Назначение кода:
# Pydantic-схемы для модуля «Рефералы» EFHC Bot.
# Этот файл определяет ВСЕ типы данных, которыми обмениваются роуты/сервисы,
# когда пользователь открывает раздел «Рефералы»:
#   • витрина «Активные» и «Неактивные» рефералы (две вкладки),
#   • курсорная пагинация без OFFSET (единый контейнер CursorPage[T]),
#   • карточка «Мои рефералы» (код, deeplink, агрегаты, бонусы),
#   • служебные DTO для «принудительной синхронизации» при открытии экрана,
#   • (опционально) привязка рефкода при старте через deeplink.
#
# Канон / инварианты:
# • «Активный реферал» — пользователь, совершивший первую покупку панели
#   (статус становится постоянным). «Неактивный» — реферал без покупок панелей.
# • Денежных операций в этом модуле НЕТ: начисления бонусов выполняет
#   банковский сервис и/или tasks/referral-сервис. Здесь только формы данных.
# • Все суммы EFHC наружу — строки с 8 знаками (Decimal, округление вниз).
# • P2P и обратные конверсии запрещены; схемы не описывают таких действий.
#
# ИИ-защита / самовосстановление:
# • Везде CursorPage[T] (next_cursor + etag) для устойчивой подгрузки списков.
# • OkMeta присутствует в комплексных ответах, чтобы фронтенд понимал «ok»
#   и мог корректно восстановиться после сетевых сбоев.
# • Служебный ответ ReferralSyncOut — резюме «догонов/освежений» при открытии.
#
# Запреты:
# • В схемах нет бизнес-логики/пересчётов; только форма данных и валидация.
# • Никаких «суточных» абстракций — весь расчёт на стороне сервисов.
# =============================================================================

from __future__ import annotations

# =============================================================================
# Импорты
# -----------------------------------------------------------------------------
from datetime import datetime
from typing import Optional, Literal, Any

from pydantic import BaseModel, Field, validator

from backend.app.schemas.common_schemas import (
    OkMeta,            # ок-обёртка для дружелюбного UI (ok/trace/ts)
    CursorPage,        # унифицированный контейнер курсорной пагинации
    d8_str,            # Decimal/число → строка с 8 знаками (ROUND_DOWN)
    IdempotencyContract,  # базовый контракт для «денежных POST» (здесь почти не нужен)
)

# =============================================================================
# Базовые карточки рефералов (две витрины: Активные и Неактивные)
# -----------------------------------------------------------------------------
class ReferralRow(BaseModel):
    """
    Карточка реферала в списках «Активные/Неактивные».
    ВАЖНО: это витрина, а не полная модель пользователя.
    """
    referee_user_id: int = Field(..., description="Внутренний ID реферала")
    referee_tg_id: int = Field(..., description="Telegram ID реферала")
    username: Optional[str] = Field(None, description="Никнейм (если есть)")
    is_active: bool = Field(..., description="Флаг активности (первая покупка панели совершена)")
    joined_at: Optional[datetime] = Field(None, description="Когда реферал присоединился к системе")
    became_active_at: Optional[datetime] = Field(None, description="Когда реферал стал активным (первая покупка панели)")
    panels_count: int = Field(..., ge=0, description="Сколько панелей купил реферал")
    total_bonus_earned_by_referrer: str = Field(
        ...,
        description="Сколько бонусов начислено пригласившему (str, 8; сумма по этому рефералу)"
    )

    @validator("total_bonus_earned_by_referrer", pre=True)
    def _q8(cls, v: Any) -> str:
        return d8_str(v)

# Страницы-контейнеры (курсоры без OFFSET) для двух вкладок
ActiveReferralsPage = CursorPage[ReferralRow]
InactiveReferralsPage = CursorPage[ReferralRow]

# =============================================================================
# Агрегаты/шапка раздела «Мои рефералы»
# -----------------------------------------------------------------------------
class MyReferralInfoOut(BaseModel):
    """
    Краткая «шапка» раздела: код/ссылка + агрегаты.
    """
    meta: OkMeta = Field(default_factory=OkMeta)
    my_user_id: int = Field(..., description="Внутренний ID текущего пользователя")
    my_tg_id: int = Field(..., description="Telegram ID текущего пользователя")
    referral_code: str = Field(..., description="Мой рефкод (стабилен)")
    deep_link: str = Field(..., description="Готовая tg-deeplink для приглашения")
    active_count: int = Field(..., ge=0, description="Количество активных рефералов")
    inactive_count: int = Field(..., ge=0, description="Количество неактивных рефералов")
    total_bonus_earned: str = Field(..., description="Суммарно бонусов начислено мне (str, 8)")
    last_bonus_at: Optional[datetime] = Field(None, description="Когда последний раз начисляли бонус")

    @validator("total_bonus_earned", pre=True)
    def _q8(cls, v: Any) -> str:
        return d8_str(v)

# =============================================================================
# Параметры курсорной пагинации для списков «Активные/Неактивные»
# -----------------------------------------------------------------------------
class ReferralsQueryIn(BaseModel):
    """
    Запрос списка рефералов для конкретной вкладки.
    • tab: 'active' | 'inactive' — выбор витрины,
    • next_cursor — курсор из предыдущего ответа,
    • limit — желаемый размер страницы (по умолчанию на стороне роутера).
    """
    tab: Literal["active", "inactive"] = Field(..., description="Выбор витрины")
    next_cursor: Optional[str] = Field(None, description="Курсор следующей страницы (base64)")
    limit: Optional[int] = Field(None, ge=1, le=200, description="Размер страницы (1..200)")

# =============================================================================
# Служебная «принудительная синхронизация» (на открытии экрана)
# -----------------------------------------------------------------------------
class ReferralsSyncOut(BaseModel):
    """
    Результат служебной синхронизации при открытии раздела.
    • refreshed — сколько записей было освежено/пересчитано,
    • errors — сколько ошибок случилось за проход.
    """
    meta: OkMeta = Field(default_factory=OkMeta)
    refreshed: int = Field(..., ge=0, description="Число освежённых/пересчитанных записей")
    errors: int = Field(..., ge=0, description="Число ошибок")
    note: Optional[str] = Field(None, description="Короткая приметка ('ok'/'partial' и т.п.)")

# =============================================================================
# (Опционально) Привязка рефкода при старте через deeplink
# -----------------------------------------------------------------------------
class ReferralAttachIn(BaseModel):
    """
    Вход при старте бота с tg-deeplink вида: ?start=<referral_code>.
    Денежной операции нет (идемпотентность на усмотрение роутера).
    """
    referral_code: str = Field(..., min_length=4, max_length=64, description="Полученный из deeplink код")

class ReferralAttachOut(BaseModel):
    """
    Результат попытки привязки реферала.
    """
    meta: OkMeta = Field(default_factory=OkMeta)
    attached: bool = Field(..., description="True, если код успешно привязан впервые")
    reason: Optional[str] = Field(None, description="Почему не привязали (например, 'self_ref', 'already_set')")

# =============================================================================
# (Опционально) Ручной «клейм» бонуса по рефералам
# -----------------------------------------------------------------------------
# Примечание: По канону бонусы начисляются централизованно банком/сервисами.
# Если когда-то добавим ручной клейм (например, за выполненные условия),
# используем IdempotencyContract для входа (денежный POST → обязателен Key).
class ReferralClaimIn(IdempotencyContract):
    """
    Запрос на клейм «реферального» бонуса (если такая механика появится).
    """
    claim_code: str = Field(..., min_length=6, max_length=64, description="Идентификатор клейма/задачи/условия")

class ReferralClaimOut(BaseModel):
    """
    Результат попытки клейма (без деталей балансов; их вернёт отдельный роут).
    """
    meta: OkMeta = Field(default_factory=OkMeta)
    claimed: bool = Field(..., description="True, если клейм состоялся идемпотентно")
    detail: Optional[str] = Field(None, description="Короткое пояснение ('already_claimed', 'ok', 'not_eligible')")

# =============================================================================
# Пояснения (для разработчиков/ревью):
# • Вкладки реализованы через ReferralsQueryIn.tab ('active'/'inactive'), а сами
#   страницы — ActiveReferralsPage/InactiveReferralsPage = CursorPage[ReferralRow].
# • Значения EFHC наружу — только строки с 8 знаками (d8_str). Денежной логики
#   здесь нет; начисления бонусов происходят в сервисах через Банк.
# • При открытии экрана фронтенд может вызвать «синхронизацию» (ReferralsSyncOut),
#   чтобы подсветить прогресс и выдержать канон «самовосстановления».
# • Привязка рефкода (ReferralAttach*) не является денежной операцией; бизнес-правила
#   (самопривязка/повторная привязка) реализуют роуты/сервисы.
# =============================================================================
