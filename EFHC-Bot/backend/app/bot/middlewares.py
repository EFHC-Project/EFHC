"""
==============================================================================
== EFHC Bot ‚Äî middlewares
------------------------------------------------------------------------------
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å aiogram-—Ö—ç–Ω–¥–ª–µ—Ä—ã –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–º–∏ –∑–∞—â–∏—Ç–∞–º–∏ EFHC, —á—Ç–æ–±—ã –±–æ—Ç
–Ω–µ –ø–∞–¥–∞–ª –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∏ –¥–∞–≤–∞–ª —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ª–æ–≥-—Ç—Ä–µ–π—Å.

–ö–∞–Ω–æ–Ω/–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã:
  ‚Ä¢ –ë–∞–ª–∞–Ω—Å—ã –∏ –ë–î –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç ‚Äî —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ—Ç –∏ –∑–∞—â–∏—â–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.
  ‚Ä¢ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –æ–±—â–∏–π logging_core —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º.
  ‚Ä¢ –ù–µ –¥–µ–ª–∞–µ—Ç —Å–µ—Ç–µ–≤—ã–µ –≤—ã–∑–æ–≤—ã –∏ –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç –±–∞–Ω–∫–æ–≤—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å.

–ò–ò-–∑–∞—â–∏—Ç—ã/—Å–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:
  ‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π try/except –Ω–∞ —É—Ä–æ–≤–Ω–µ middleware –¥–∞—ë—Ç –º—è–≥–∫—É—é –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—é –±–µ–∑ –ø–∞–¥–µ–Ω–∏—è
    –≤–æ—Ä–∫–µ—Ä–∞ aiogram.
  ‚Ä¢ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–µ—Ç—Ä–∞—è–º –∏ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤.

–ó–∞–ø—Ä–µ—Ç—ã:
  ‚Ä¢ –ù–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ–Ω–µ–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Idempotency-Key (—ç—Ç–æ —Å–ª–æ–π API).
  ‚Ä¢ –ù–µ –º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM –∏ –Ω–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.
==============================================================================
"""

from __future__ import annotations

from aiogram import BaseMiddleware
from aiogram.types import Message

from ..core.logging_core import get_logger

logger = get_logger(__name__)


class LoggingMiddleware(BaseMiddleware):
    """–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.

    –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—Ö–æ–¥—è—â–µ–≥–æ –∞–ø–¥–µ–π—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
    –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –≤ –ª–æ–≥–∞—Ö.
    –í—Ö–æ–¥: event/message aiogram.
    –í—ã—Ö–æ–¥: –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É.
    –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã: —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ; –ë–î –∏ –±–∞–ª–∞–Ω—Å—ã –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç.
    –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.
    –ò—Å–∫–ª—é—á–µ–Ω–∏—è: –Ω–µ –ø–æ–¥–Ω–∏–º–∞–µ—Ç; –æ—à–∏–±–∫–∏ –ª–æ–≥–≥–µ—Ä–∞ –Ω–µ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Ü–µ–ø–æ—á–∫—É.
    –ò–ò-–∑–∞—â–∏—Ç–∞: –ª–æ–≥–∏—Ä—É–µ—Ç sender.id, —á—Ç–æ–±—ã —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∫–ª–∏–∫–∏/—Å–ø–∞–º.
    """

    async def __call__(self, handler, event: Message, data):  # type: ignore[override]
        logger.info(
            "bot message",
            extra={"from": event.from_user.id if event.from_user else None},
        )
        return await handler(event, data)


class SafeMiddleware(BaseMiddleware):
    """–û–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç —Ö—ç–Ω–¥–ª–µ—Ä—ã –∏ –ª–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏ –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞.

    –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –∑–∞—â–∏—Ç–∏—Ç—å aiogram-–≤–æ—Ä–∫–µ—Ä –æ—Ç –ø–∞–¥–µ–Ω–∏–π –ø—Ä–∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    –í—Ö–æ–¥: message –∫–æ–Ω—Ç–µ–∫—Å—Ç aiogram.
    –í—ã—Ö–æ–¥: None; –ø–µ—Ä–µ–¥–∞—ë—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–ª—å—à–µ –ø–æ —Ü–µ–ø–æ—á–∫–µ middleware/handler.
    –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã: —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ; –ë–î –∏ –±–∞–ª–∞–Ω—Å—ã –Ω–µ —Ç—Ä–æ–≥–∞—é—Ç—Å—è.
    –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –≤—ã–∑–æ–≤ –Ω–µ –º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ.
    –ò—Å–∫–ª—é—á–µ–Ω–∏—è: –ø–æ–¥–∞–≤–ª—è–µ—Ç –ª—é–±—ã–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è, –∑–∞–ø–∏—Å—ã–≤–∞—è –∏—Ö –≤ –ª–æ–≥,
    –∏ –Ω–µ –ø—É—Å–∫–∞–µ—Ç –∏—Ö –Ω–∞—Ä—É–∂—É.
    –ò–ò-–∑–∞—â–∏—Ç–∞: ¬´–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–∞–¥–∞–π¬ª ‚Äî –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç fallback-—Å–æ–æ–±—â–µ–Ω–∏–µ–º –¥–∞–∂–µ –ø—Ä–∏
    –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
    """

    async def __call__(self, handler, event: Message, data):  # type: ignore[override]
        try:
            return await handler(event, data)
        except Exception as exc:  # noqa: BLE001
            logger.exception("bot handler failed", exc_info=exc)
            if isinstance(event, Message):
                await event.answer("ü§ñ –ë–æ—Ç —Å–µ–π—á–∞—Å –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ.")
        return None


# ============================================================================
# –ü–æ—è—Å–Ω–µ–Ω–∏—è ¬´–¥–ª—è —á–∞–π–Ω–∏–∫–∞¬ª:
#   ‚Ä¢ Middleware –Ω–µ –¥–≤–∏–≥–∞—é—Ç –¥–µ–Ω—å–≥–∏ –∏ –Ω–µ —Ö–æ–¥—è—Ç –≤ –ë–î ‚Äî —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É—é—Ç –∏ –∑–∞—â–∏—â–∞—é—Ç
#     –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.
#   ‚Ä¢ –î–∞–∂–µ –µ—Å–ª–∏ —Ö—ç–Ω–¥–ª–µ—Ä —É–ø–∞–ª, SafeMiddleware –Ω–µ –¥–∞—ë—Ç –±–æ—Ç—É –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∏ –ø–∏—à–µ—Ç
#     –≤ –ª–æ–≥ –ø—Ä–∏—á–∏–Ω—É.
#   ‚Ä¢ LoggingMiddleware —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –¥–ª—è —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π —Å–ø–∞–º–∞ –∏ –ø–æ–≤—Ç–æ—Ä–æ–≤.
# ============================================================================
