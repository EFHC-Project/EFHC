# -*- coding: utf-8 -*-
# backend/app/services/admin_service.py
# =============================================================================
# EFHC Bot — ЕДИНАЯ точка входа в административный модуль
# -----------------------------------------------------------------------------
# Назначение файла:
#   • Дать внешнему коду (роуты FastAPI, background-воркеры, тесты) ОДИН
#     канонический вход в админ-функционал бота.
#   • Спрятать внутреннюю модульную структуру:
#       backend/app/services/admin/
#         ├── admin_facade.py            → AdminService (фасад)
#         ├── admin_rbac.py              → RBAC, AdminUser, AdminRole, AdminAuthError
#         ├── admin_logging.py           → AdminLogger, AdminLog
#         ├── admin_settings.py          → SettingsService, SystemSetting, ALLOWED_SETTINGS
#         ├── admin_notifications.py     → AdminNotifier, AdminNotification
#         ├── admin_bank_service.py      → Банк EFHC, минт/бёрн, П↔Банк
#         ├── admin_lotteries_service.py → Лотереи/билеты/призы (бонусы, NFT)
#         ├── admin_panels_service.py    → Панели пользователей (вкл/выкл)
#         ├── admin_referral_service.py  → Реферальные бонусы (ТОЛЬКО бонусный счёт)
#         ├── admin_wallets_service.py   → Кошельки (просмотр/привязка, без денег)
#         ├── admin_stats_service.py     → Статистика для дашборда
#         ├── admin_users_service.py     → Просмотр/отладка прогресса и балансов
#         └── admin_withdrawals_service.py
#                                      → Заявки на вывод EFHC, выдача NFT по заявкам
#
# Ключевые инварианты (канон, ИИ-страховка):
#   1) НЕТ внутренних переводов «пользователь ↔ пользователь».
#      Все денежные потоки только:
#        • Банк EFHC → Пользователь;
#        • Пользователь → Банк EFHC.
#      Это соблюдается на уровне внутренних сервисов (bank/referral/withdrawals).
#
#   2) Начальный баланс банка — 5 000 000 EFHC.
#      Фиксируется миграциями/инициализацией и НИКОГДА не эмитится «из воздуха»
#      в обход банка. Любые ручные корректировки балансов идут строго через
#      банковский сервис (идемпотентные операции с idempotency_key).
#
#   3) Идемпотентность:
#        • Любая операция, создающая/списывающая EFHC (включая бонусы, лотереи,
#          задания, реферальные уровни, ручные начисления админа), должна
#          быть идемпотентной на уровне своей таблицы (ON CONFLICT / уникальные
#          ключи, явный idempotency_key, отметки "уже выплачено" и т.п.).
#        • Этот модуль сам по себе денег не двигает, но импортирует только те
#          подмодули, где это правило соблюдено (ИИ-страховка уровня архитектуры).
#
#   4) Бонусные начисления:
#        • Все бонусы (реферальные, задания, лотереи, промо) зачисляются ТОЛЬКО
#          на бонусный EFHC-счёт пользователя.
#        • Обычный (regular) EFHC используется для базовых расчётов/покупок,
#          но не для бонусов, чтобы отличать «заработанное» от «вознаграждений».
#
#   5) Лотереи и задания:
#        • Параметры (цена билета, лимиты, тип приза) универсальны и могут
#          полностью изменяться через админку.
#        • Реализована архитектура автоперезапуска лотерей/тасков по настройкам
#          (конкретная логика запуска/cron реализуется в воркерах).
#        • Есть возможность временной приостановки/возобновления.
#
#   6) Ручные корректировки:
#        • Администратор может выполнять только операции «пользователь ↔ банк»
#          (поправки/компенсации, выдача на вывод, закрытие заявок).
#        • Любая такая операция логируется в admin_logs, а транзакции — в
#          банковских логах, с привязкой idempotency_key.
#
#   7) Отладка и просмотр прогресса:
#        • Через AdminUsersService предусмотрены функции открытия «окна игры»
#          по Telegram ID для просмотра прогресса, панелей, энергии и балансов,
#          с возможностью безопасной коррекции (с логированием).
#
# Как использовать этот файл:
#   • Во внешнем коде импортируем ТОЛЬКО отсюда:
#       from backend.app.services.admin_service import AdminService
#
#   • Никаких прямых импортов подмодулей в бизнес-роутах (кроме тестов/утилит):
#       from backend.app.services.admin import admin_bank_service  # только для тестов
#
#   • Если нужен расширенный доступ к DTO/моделям — рекомендуется импортировать
#     их из соответствующих подмодулей, но основной сценарий — работать через
#     AdminService как через фасад (см. admin_facade.py).
# =============================================================================

from __future__ import annotations

# Важно: относительные импорты, чтобы модуль был переносим внутри backend.app
# Импортируем подмодули, чтобы:
#   • гарантировать их доступность и регистрацию при старте приложения;
#   • упростить работу IDE/линтеров (они «видят» модуль как пакет admin.*).
from .admin import (
    admin_facade,
    admin_rbac,
    admin_logging,
    admin_settings,
    admin_notifications,
    admin_bank_service,
    admin_lotteries_service,
    admin_panels_service,
    admin_referral_service,
    admin_wallets_service,
    admin_stats_service,
    admin_users_service,
    admin_withdrawals_service,
)

# Основной фасад админки — то, с чем работает внешний код.
from .admin.admin_facade import AdminService  # noqa: F401

# Опционально: наружу экспортируется только фасад.
# Остальные подмодули считаются внутренними и могут меняться без влияния на API.
__all__ = [
    "AdminService",
]

