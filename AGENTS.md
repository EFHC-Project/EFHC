# AGENTS.md — EFHC Bot Canon v2.8 (обязательные правила)

## 1. Источник правды: константы, точность, инварианты

### 1.1. Константы генерации (единственно допустимые)

* `GEN_PER_SEC_BASE_KWH = 0.00000692` — базовая ставка, кВт·ч/сек (без VIP).
* `GEN_PER_SEC_VIP_KWH  = 0.00000741` — VIP-ставка, кВт·ч/сек.
  Эти значения:
* задаются в `config_core.py`;
* проверяются в `system_locks.py::assert_per_sec_canon()`;
* нигде в коде не дублируются «суточными» константами. 

### 1.2. Денежная точность

* Все суммы в EFHC и kWh — `Decimal` с 8 знаками после запятой, округление вниз.
* В БД — `Numeric(30, 8)`.
* Округление — через утиль в `utils_core.py`: `quantize_decimal(..., decimals=8, rounding="DOWN")`. 

### 1.3. Экономические инварианты

* Обмен только `kWh → EFHC` (1:1). Обратной конверсии `EFHC → kWh` нет и быть не может.
* P2P `user → user` запрещён. Любые EFHC-движения идут через «Банк EFHC»:

  * «банк → пользователь» (кредит),
  * «пользователь → банк» (дебет).
* Пользователь никогда не уходит в минус (ни `main`, ни `bonus`):

  * если исторически минус уже есть — покупки за EFHC блокируются,
  * пополнение / `kWh → EFHC` разрешены до выхода в `>= 0`.
* Банк может уходить в минус — это не блокирует операции:

  * фиксируется в логах флагом `processed_with_deficit`,
  * логика минуса — в `BankState` + `efhc_transfers_log`.
    Все проверки централизованы в `system_locks.py` и банковском сервисе. 

---

## 2. NFT / VIP

* VIP-статус определяется только наличием NFT из канонической коллекции в кошельке пользователя.
* Проверка VIP:

  * циклически каждые 10 минут (планировщик `check_vip_nft.py`),
  * при входе в раздел (через API).
* Выдача NFT:

  * только вручную по заявке со статусом `PAID_PENDING_MANUAL`,
  * авто-минт запрещён. 

---

## 3. TON-входящие и MEMO

Поддерживаем канонические форматы MEMO:

1. `EFHC<tgid>` → прямое пополнение EFHC для пользователя `<tgid>`.
2. `SKU:EFHC|Q:<INT>|TG:<id>` → покупка EFHC-пакета (Q — размер пакета, `<id>` — Telegram ID).
3. `SKU:NFT_VIP|Q:1|TG:<id>` → оплата VIP NFT; создаёт заявку на NFT со статусом `PAID_PENDING_MANUAL`. 

Идемпотентность TON-входящих:

* `tx_hash` в `ton_inbox_logs` — `UNIQUE`.
* При повторе того же `tx_hash` — read-through:

  * либо обнаруживаем уже проведённый лог и не создаём дубль,
  * либо догоняем обработку, если лог есть, а кредит не завершён.
    Статусы TON-логов: `received`, `parsed`, `credited`, `error_*`.
    Есть поля `next_retry_at` и `retries_count` для ретраев. 

---

## 4. Идемпотентность, списки, планировщик

### 4.1. Идемпотентность

* Любой денежный `POST/PUT/PATCH/DELETE` требует заголовок `Idempotency-Key`.
* Проверка:

  * зависимость `require_idempotency_key` в `system_locks.py`,
  * дополнительная страховка через `MonetaryIdempotencyMiddleware`.
* В журнале банка `efhc_transfers_log`:

  * поле `idempotency_key` — `UNIQUE`,
  * повтор с тем же ключом не создаёт новых движений, а возвращает предыдущий результат. 

### 4.2. Списки

* Только cursor-based пагинация, без `OFFSET`.
* Формат ответа: `items`, `next_cursor`, `has_more`.
* ETag:

  * на списки и ресурсы выдаётся `ETag` (стабильный хэш),
  * фронт может использовать `If-None-Match` для кэширования. 

### 4.3. Планировщик

* Единый тик для всех задач: каждые 10 минут.
* Принцип: «время — триггер, не фильтр»:

  * не используем «обработать последние N минут»,
  * обрабатываем все записи со статусом не финальным и `next_retry_at <= now`. 

### 4.4. Логи и ретраи

* Любая ошибка не валит цикл, а:

  * пишет статус `error_*`,
  * выставляет `next_retry_at`,
  * увеличивает `retries_count`.
* При старте планировщик делает догон незавершённых записей. 

---

## 5. Канон автономной ИИ-автоматизации

1. Система не останавливается. Любые сбои локализуются в логах и статусах.
2. Все денежные операции — только через банк (`transactions_service.py`) с read-through-идемпотентностью.
3. Строгое разделение слоёв:

   * CRUD — работа с таблицами, без денег.
   * Services — бизнес-логика; деньги только через банковский сервис.
   * Routes — тонкий слой: валидация, `Idempotency-Key`, курсоры, `ETag`.
4. Расчёты энергии — только per-sec ставки, никакой «суточной магии».
5. Frontend:

   * при входе в любой раздел вызывается принудительная синхронизация (бек делает догон по логам),
   * главный экран анимирует посекундную генерацию и каждые ~10 минут сверяется с бэкендом.
6. В Panels есть «Активные» и «Архив» (или единый список с бейджами).
7. Shop:

   * показывает все карточки,
   * `price = 0` → карточка деактивирована,
   * все цены и валюты задаёт админ в БД. 

---

## 6. Бизнес-правила по доменам

### 6.1. Панели

* Цена панели: 100 EFHC.
* Лимит на пользователя: `MAX_PANELS = 1000`.
* Срок жизни панели (пример) — 180 дней (фиксируется в ТЗ и миграции).
* Начисление энергии:

  * только по per-sec ставкам,
  * бек делает: backfill на тиках планировщика и «догон» при открытии Panels / главного экрана.
* Покупка панели:

  * списание: сначала `bonus`, затем `main`,
  * если расчёт даёт минус — операция запрещена (`ensure_user_non_negative_after`). 

### 6.2. Обменник

* Работает только в сторону `kWh → EFHC` (1:1).
* Схема: уменьшаем `available_kwh`, через банк кредитуем EFHC; обратного пути нет. 

### 6.3. Рейтинг

* Рейтинг «Я + TOP-100».
* Источник истины — `total_generated_kwh`, а не доступный баланс.
* Снепшоты рейтинга используются для ускорения (`rating_snapshots`). 

### 6.4. Рефералы

* «Активный» реферал — после первой покупки панели. До этого — «Неактивный».
* Витрины разнесены: список активных / список неактивных.
* Бонусы начисляются через банк. 

### 6.5. Задания / Реклама

* Витрина задач/рекламных активностей:

  * пользователь видит список заданий,
  * отправляет доказательства,
  * задания проходят модерацию админом.
* Выплата бонусов за задания:

  * только через банк (идемпотентно),
  * фиксируется в `efhc_transfers_log`. 

### 6.6. Лотереи

* Всегда `lotteries`, без `lottery_*`.
* Билеты продаются за EFHC.
* Таблицы: `lotteries`, `lottery_tickets`.
* Все движения — через банк.
* Никаких Stars/TON для покупки билетов, только EFHC внутри бота.
* Каждый POST на покупку билета:

  * содержит `Idempotency-Key`,
  * проходит через `transactions_service`,
  * создаёт запись в `efhc_transfers_log`;
  * повтор того же `Idempotency-Key` не создаёт второй билет и не дублирует перевод. 

### 6.7. Shop

* Каталог EFHC-пакетов: 10/50/100/200/300/400/500/1000 EFHC, оплата TON/USDT снаружи, внутренняя логика через TON watcher.
* Карточка деактивирована, если цена = 0.
* VIP NFT: после оплаты создаётся заявка `PAID_PENDING_MANUAL`, выдача вручную.
* Пакеты EFHC пополняют баланс через цепочку: TON входящие → `ton_inbox_logs` → банк → баланс пользователя.
* Покупка панелей/пакетов/VIP-NFT/билетов/заданий/выводов — денежные операции только через банк, с `Idempotency-Key`, и логируются в `efhc_transfers_log`. 

---

## 7. TON-входящие и реконсиляция

* Парсер MEMO детерминированный, живёт в `integrations/ton_api.py`.
* `tx_hash` — `UNIQUE`.
* Статусы: `received`, `parsed`, `credited`, `error_*`.
* Поля `next_retry_at`, `retries_count` — для автоматических ретраев.
* Реконсиляция запускается из админки, по `since_utime` или диапазону последних N часов. 

---

## 8. Доступ и админка

Админ-доступ допускается, если выполняется любое из:

1. `ADMIN_TELEGRAM_ID` (канонический список админов);
2. наличие админ-NFT в кошельке;
3. валидный серверный `X-Admin-Api-Key`.

Админ может:

* делать корректировки банк ↔ пользователь (main/bonus, debit/credit);
* управлять витринами Shop/Tasks/Lotteries/Ads;
* запускать реконсиляции TON;
* смотреть отчёты, метрики, логи. 

---

## 9. Архитектура

* Backend: FastAPI + SQLAlchemy async + PostgreSQL (Neon) + Alembic.
* Scheduler: фоновые корутины с тиками раз в 10 минут:
  `generate_energy.py`, `check_vip_nft.py`, `check_ton_inbox.py`, `update_rating.py`, `archive_panels.py`, `lotteries_autorestart.py`, `tasks_autorestart.py`, `ads_rotation.py`, `reports_daily.py`.
* Integrations:
  `ton_api.py` (таймауты, фолбэк узлов, детерминированный MEMO-парсер),
  `telegram_ads_api.py`.
* Bot (aiogram): команды, верификация заданий, текстовые подсказки.
* WebApp (Next.js/React + Tailwind): Energy/Panels/Exchange/Shop/Rating/Referrals/Tasks/Ads/Admin. 

---

## 10. Ключевые таблицы и индексы

Минимальный набор:

* `users` — балансы (main, bonus), `available_kwh`, `total_generated_kwh`, `is_vip`, кошельки.
* `panels` — панели, срок жизни, статусы; индексы по `user_id`, `created_at`.
* `efhc_transfers_log` — зеркальные записи «банк ↔ пользователь», `idempotency_key UNIQUE`, флаг дефицита.
* `ton_inbox_logs` — `tx_hash UNIQUE`, статусы, ретраи.
* `user_tasks`, `task_submissions` — задачи.
* `referrals` — дерево и активность.
* `rating_snapshots` — ускорение рейтинга.
* `shop_items`, `shop_orders` — карточки и заказы; `tx_hash UNIQUE` при оплате.
* `lotteries`, `lottery_tickets` — лотереи.
* `ads_campaigns / ads_impressions` — при необходимости.
  Индексы для курсоров: `(created_at, id)` на основных витринных таблицах. 

---

## 11. API-правила

* Любой денежный `POST/PUT/PATCH/DELETE` → обязателен `Idempotency-Key`.
  При отсутствии — 400 с текстом:
  `"Idempotency-Key header is strictly required for monetary operations."`
* Списки возвращают `next_cursor`, `has_more`, `ETag`.
* GET-ручки разделов триггерят «догон» по логам:
  обрабатываются все записи со статусом не финальным и `next_retry_at <= now`, без фильтра «последние N минут».
* Любой денежный POST обязан:
  содержать `Idempotency-Key`;
  вести операцию через `transactions_service`;
  создавать запись в `efhc_transfers_log`. 

---

## 12. TON / MEMO — ещё раз кратко

* `EFHC<tgid>` → пополнение EFHC пользователю.
* `SKU:EFHC|Q:<INT>|TG:<id>` → заказ EFHC-пакета.
* `SKU:NFT_VIP|Q:1|TG:<id>` → заявка на VIP NFT (ручная выдача).
* `tx_hash` — ключ идемпотентности для всех входящих операций. 

---

## 13. Канонические адреса

* TON-кошелёк проекта (депозиты):
  `UQAyCoxmxzb2D6cmlf4M8zWYFYkaQuHbN_dgH-IfraFP8QKW`
* NFT-коллекция VIP (TON):
  `EQASPXkEI0NsZQzqkPjk6O_i752LfwSWRFT9WzDc2SJ2zgi0` 
