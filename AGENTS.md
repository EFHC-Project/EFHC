# AGENTS.md — EFHC Bot Canon v2.8 (полный агент-канон для Codex)

Этот файл — **единственный и верховный источник правил** для Codex и любых агентных действий по репозиторию EFHC-Bot.
Любой код, правка, перемещение файлов, коммит или PR **обязаны соответствовать** этому файлу.
Если есть конфликт между AGENTS.md и любыми другими источниками — приоритет у AGENTS.md.

---

## 0. Краткая миссия проекта

EFHC Bot — Telegram-бот + WebApp, реализующие игровую экономику EFHC (Energy for Humanity Coin), где внутренняя единица энергии kWh конвертируется в EFHC **строго 1:1**, а вся финансовая логика проходит через единый “Банк EFHC”.
Проект строится на принципах: прозрачность, строгие инварианты, идемпотентность, автономная самовосстанавливающаяся работа, отсутствие P2P и обратной конверсии.

---

## A. Как Codex должен работать с проектом (обязательный режим)

### A1. Итерационный режим

Codex работает итерациями. Одна итерация может затрагивать любой набор файлов, но правила поведения неизменны:

1. **Сначала понять:**

   * кратко описать, что понял из текущих файлов/контекста;
   * задать вопросы, если не хватает данных.

2. **Не коммитить до ответов:**

   * если есть вопросы — Codex **не имеет права** коммитить изменения, пока пользователь не ответит.

3. **После ответов — сделать работу полностью.**

---

### A2. Миграция и пересборка под схему v2.8

Codex обязан:

* разложить и пересобрать код **строго 1:1 по канонической схеме EFHC-Bot v2.8** (названия файлов/папок — только как в схеме);
* **не создавать никаких новых имён/файлов сверх схемы**;
* переносить существующий код в правильные места;
* обновлять импорты/пути/имена модулей **только** для корректной сборки;
* **запрещено менять бизнес-логику, экономику и инварианты EFHC** без прямого указания пользователя.

Если по схеме нужен файл, но кода для него в текущей итерации нет:

* создать пустой **канонический скелет** (без логики) и пометить `# ожидается в следующих итерациях`.

---

### A3. Запрет на “мини-заглушки”

Если Codex трогает файл — он обязан:

* **вернуть файл целиком** (полный текст), даже если 500–1500 строк;
* не сокращать и не оставлять “по 5–10 строк”;
* не оставлять `TODO`, `pass`, `placeholder`.

Если контекста не хватает — **спросить**, а не сокращать.

---

### A4. “Живая” ИИ-защита и самовосстановление (канон поведения кода)

Во всех затрагиваемых доменах Codex обязан сохранять/добавлять паттерны автономности:

* фоновые циклы/планировщик **не падают** от одной ошибки;
* любая ошибка локализуется в статусе/логе и не валит тик;
* ретраи только “мягкие”: `next_retry_at`, `retries_count`;
* read-through идемпотентность:

  * по `Idempotency-Key` для денежных запросов;
  * по `tx_hash` для TON-входящих;
* генерация энергии — только per-sec ставки (никаких дневных/суточных “магий”);
* защита от гонок/дублей там, где это требуется каноном (advisory locks / SKIP LOCKED / UNIQUE + read-through).

**Важно:** Codex **не придумывает новые домены/механики**, а применяет эти правила только внутри существующих модулей.

---

### A5. Стиль, качество, проверки

Любой новый или правленный код обязан соответствовать:

* PEP8;
* black-подобному форматированию;
* flake8/ruff-подобному линтингу (ошибки не прятать);
* mypy-подобной строгой типизации (type hints везде, где возможно);
* внутреннему канону EFHC (термины, имена, инварианты, запреты).

---

### A6. Комментарии — эталон EFHC v1.1 (обязателен)

Для каждого файла Codex обязан применять **эталон комментариев v1.1**: 

**1) Шапка файла сверху (обязательная):**

* назначение (1–3 строки);
* канон/инварианты, влияющие на деньги/безопасность;
* если модуль не трогает деньги — явно `балансы не изменяет`;
* ИИ-защиты/самовосстановление;
* запреты (P2P, EFHC→kWh, авто-NFT и т.д.).

**2) Комментарии к импортам/константам:**

* зачем нестандартные зависимости и переменные env;
* все денежные/энергетические числа — Decimal(8), округление вниз, через единый хелпер;
* канонические per-sec ставки — только из `config_core.py`.

**3) Докстринги функций/роутов:**

* назначение, вход, выход, побочные эффекты;
* идемпотентность;
* исключения (HTTP-коды);
* ИИ-защита.

**4) SQL/алгоритмы:**

* перед SQL — строка “что и зачем”;
* для курсоров — краткое описание ключа;
* мягкая деградация, если таблиц нет.

**5) Запрет TODO**

* TODO/FIXME/заглушек нет;
* если что-то запрещено — прямо пишем “не делает, потому что запрещено каноном”.

**6) Внизу файла — “Пояснения для чайника” (4–6 тезисов).**

---

### A7. Формат ответа Codex

После выполнения итерации Codex всегда выдаёт:

1. **MAPPING**
   `old_path_or_name → new_path_by_v2.8`

2. **FILES**
   `FILE: <new_path>`
   `<полный готовый код файла>`

---

## B. Канон экономики и безопасности EFHC (ядро v2.8)

### B1. Константы генерации (единственно допустимые)

* `GEN_PER_SEC_BASE_KWH = 0.00000692` — базовая ставка, кВт·ч/сек (без VIP).
* `GEN_PER_SEC_VIP_KWH  = 0.00000741` — VIP-ставка, кВт·ч/сек.

Правила:

* задаются **только** в `config_core.py`;
* проверяются в `system_locks.py::assert_per_sec_canon()`;
* **запрещено** дублировать “суточными” константами.

---

### B2. Денежная точность

* все суммы EFHC/kWh — `Decimal` с 8 знаками після запятой;
* округление вниз;
* в БД `Numeric(30, 8)`;
* округление только через `quantize_decimal(..., decimals=8, rounding="DOWN")` в `utils_core.py`.

---

### B3. Экономические инварианты

1. **Обмен только kWh → EFHC (1:1).**
   Обратной конверсии EFHC → kWh **нет и быть не может**.

2. **P2P user → user запрещён.**
   Любые движения EFHC идут через банк:

   * `банк → пользователь` (credit),
   * `пользователь → банк` (debit).

3. **Пользователь не может уйти в минус (ни main, ни bonus).**

   * если минус уже есть — покупки заблокированы;
   * пополнения/обмен kWh→EFHC разрешены до выхода в `>= 0`.

4. **Банк может быть отрицательным.**

   * операции не блокируются;
   * фиксировать в логах флаг `processed_with_deficit`;
   * политика дефицита реализуется в `BankState` и `efhc_transfers_log`.

Вся проверка — централизована в `system_locks.py` и `transactions_service.py`.

---

## C. VIP/NFT

1. VIP определяется **только** наличием NFT из канонической коллекции в кошельке.
2. Проверка VIP:

   * циклически каждые 10 минут (`scheduler/check_vip_nft.py`);
   * при входе пользователя в раздел (API).
3. Выдача VIP NFT:

   * только вручную;
   * заявка после оплаты имеет статус `PAID_PENDING_MANUAL`;
   * авто-минт запрещён.

---

## D. TON-входящие и MEMO

### D1. Канонические форматы MEMO

1. `EFHC<tgid>` → прямое пополнение EFHC пользователю `<tgid>`.
2. `SKU:EFHC|Q:<INT>|TG:<id>` → покупка EFHC-пакета.
3. `SKU:NFT_VIP|Q:1|TG:<id>` → оплата VIP-NFT, создаёт заявку `PAID_PENDING_MANUAL`.

Парсер MEMO живёт в `integrations/ton_api.py`, детерминированный.

---

### D2. Идемпотентность TON-входящих

* `tx_hash` в `ton_inbox_logs` — `UNIQUE`.
* Повтор того же `tx_hash` → read-through:

  * либо лог уже проведён;
  * либо догоняем, если кредит не завершён.

Статусы: `received`, `parsed`, `credited`, `error_*`.
Поля ретраев: `next_retry_at`, `retries_count`.

---

## E. Идемпотентность запросов и банк

### E1. Денежные операции

Любой денежный `POST/PUT/PATCH/DELETE` **обязан** иметь заголовок `Idempotency-Key`.

Проверка:

* `require_idempotency_key` (Depends) в `system_locks.py`;
* `MonetaryIdempotencyMiddleware`.

Журнал банка:

* `efhc_transfers_log.idempotency_key` — `UNIQUE`;
* повтор ключа не создаёт движения, возвращает прежний результат.

---

### E2. Банковский сервис — единственная точка денег

Только `transactions_service.py` двигает EFHC между банком и пользователем.
CRUD-слой денег не трогает.

---

## F. Списки, курсоры, ETag

1. Только cursor-based пагинация (keyset), **никаких OFFSET**.
2. Ответ списков:

```json
{
  "items": [...],
  "next_cursor": "str | null",
  "has_more": true/false
}
```

3. ETag:

* на списки и ресурсы выдаётся стабильный ETag;
* при `If-None-Match` → 304.

---

## G. Планировщик и догон

1. Единый тик всех фоновых задач: каждые 10 минут.
2. “Время — триггер, не фильтр”:

* не “последние N минут”;
* обрабатываем все записи со статусом не финальным и `next_retry_at <= now`.

3. Ошибки:

* не валят цикл;
* пишут `error_*`;
* увеличивают `retries_count`;
* ставят `next_retry_at`.

4. При старте scheduler делает backfill незавершённого.

---

## H. Доменная логика

### H1. Panels

* Цена панели: **100 EFHC**.
* Лимит на пользователя: `MAX_PANELS = 1000`.
* Срок жизни панели — 180 дней (фиксируется в миграции).
* Генерация энергии:

  * только per-sec ставки;
  * начисление через backfill scheduler + догон при входе в Panels/главный экран.
* Покупка панели:

  * списание сначала `bonus`, затем `main`;
  * если после списания баланс < 0 — запрещено (`ensure_user_non_negative_after`).

---

### H2. Exchange

* Только `kWh → EFHC (1:1)`.
* Схема:

  1. уменьшаем `available_kwh`;
  2. через банк кредитуем EFHC;
  3. обратной операции не существует.

---

### H3. Rating

* Рейтинг “Я + TOP-100”.
* Истина — `total_generated_kwh`, не `available_kwh`.
* Для ускорения — `rating_snapshots`.

---

### H4. Referrals

* Активный реферал = купил хотя бы 1 панель (статус постоянный).
* До этого — неактивный.
* Две витрины: активные и неактивные.
* Бонусы начисляются через банк.

---

### H5. Tasks / Ads

* Пользователь видит задания/рекламу → отправляет доказательства → админ модерирует.
* Выплаты бонусов:

  * только банковским сервисом;
  * идемпотентно;
  * логируются в `efhc_transfers_log`.

---

### H6. Lotteries

* Всегда **lotteries** (не lottery_*).
* Билеты покупаются только за EFHC.
* Таблицы: `lotteries`, `lottery_tickets`.
* Любая покупка билета:

  * денежная операция через банк;
  * `Idempotency-Key` обязателен;
  * повтор ключа не создаёт второй билет.

Stars/TON внутри лотерей запрещены.

---

### H7. Shop

* EFHC-пакеты: 10/50/100/200/300/400/500/1000 EFHC.
* Оплата снаружи TON/USDT → обработка ton watcher → кредит через банк.
* `price = 0` → карточка деактивирована.
* VIP NFT после оплаты → заявка `PAID_PENDING_MANUAL`, выдача вручную.

Все покупки в Shop — денежные операции через банк.

---

## I. Доступ и админка

Админ-доступ разрешён, если выполняется одно из:

1. Telegram ID входит в `ADMIN_TELEGRAM_ID`;
2. есть админ-NFT в кошельке;
3. валиден `X-Admin-Api-Key`.

Админ может:

* корректировки банк ↔ пользователь (main/bonus, debit/credit);
* управление витринами Shop/Tasks/Lotteries/Ads;
* запуск реконсиляции TON;
* просмотр логов/метрик/репортов.

---

## J. Архитектура и стек

Backend:

* FastAPI async
* SQLAlchemy 2.0 async
* asyncpg
* Alembic
* PostgreSQL (Neon)

Scheduler:

* корутины раз в 10 минут:
  `generate_energy.py`,
  `check_vip_nft.py`,
  `check_ton_inbox.py`,
  `update_rating.py`,
  `archive_panels.py`,
  `lotteries_autorestart.py`,
  `tasks_autorestart.py`,
  `ads_rotation.py`,
  `reports_daily.py`.

Integrations:

* `ton_api.py` (сетевые таймауты, фолбэк узлов, детерминированный MEMO-парсер);
* `telegram_ads_api.py`.

Bot:

* aiogram v3.

Frontend:

* Next.js/React + Tailwind;
* разделы: Energy, Panels, Exchange, Shop, Rating, Referrals, Tasks, Ads, Admin.

---

## K. Ключевые таблицы и индексы

Минимум:

* `users`
* `panels`
* `efhc_transfers_log`
* `ton_inbox_logs`
* `referrals`
* `user_tasks`, `task_submissions`
* `rating_snapshots`
* `shop_items`, `shop_orders`
* `lotteries`, `lottery_tickets`
* `ads_campaigns`, `ads_impressions` (если используются)

Индексы для курсоров: `(created_at, id)` по всем основным витринам.

---

## L. Канонические адреса

* TON-кошелёк депозита проекта:
  `UQAyCoxmxzb2D6cmlf4M8zWYFYkaQuHbN_dgH-IfraFP8QKW`
* VIP NFT коллекция:
  `EQASPXkEI0NsZQzqkPjk6O_i752LfwSWRFT9WzDc2SJ2zgi0`

---

## M. Запреты (жёсткие)

Codex и код проекта **никогда не имеют права**:

* добавить P2P EFHC user→user;
* добавить обратную конверсию EFHC→kWh;
* ввести автодоставку/автоминт VIP NFT;
* использовать суточные/дневные ставки вместо per-sec;
* менять экономику банка без прямого указания пользователя;
* вводить “временные заглушки”.

---

## N. Контроль перед PR

Перед открытием PR Codex обязан сам проверить:

1. соблюдены константы per-sec и только они;
2. деньги идут только через банк;
3. Idempotency-Key везде, где деньги;
4. списки все cursor-based + ETag;
5. scheduler тикает раз в 10 минут и не падает;
6. нет TODO/FIXME;
7. комментарии по эталону v1.1; 
8. PEP8/black/ruff/mypy-уровень качества.
